{% extends "base.html" %}
{% block content %}

<script>
  enableSendBtn = () => {
    if(messageField.value === "") { sendBtn.disabled = true; } 
    else { sendBtn.disabled = false; }
  }


  async function sendMessage() {
    let fd = new FormData();
    let token = '{{ csrf_token }}';
    fd.append('textmessage', messageField.value);
    fd.append('csrfmiddlewaretoken', token);
    const today = new Date();
    const currMonth = today.toLocaleDateString("en-us", { month: "short" });
    let currdateFormat = currMonth + '. ' + today.getDate() + ', ' + today.getFullYear();
    try {
      messageContainer.innerHTML += `
        <div style="display: flex;  flex-direction: column" id="deleteMessageContainer" class="grey-color">
          <div>
            <span class="grey-color">[${currdateFormat}]</span> 
            {{ request.user.first_name }}: <i>${messageField.value}</i> 
          </div>
          <div>
            <i class="material-icons">done</i>
          </div>
        </div>
      `;
        let response = await fetch('/chat/', {
            method: 'POST',
            body: fd
        });
        let json = await response.json();
        let nmd = JSON.parse(json);
        console.log('Message ', nmd.fields);
        document.getElementById('deleteMessageContainer').remove();
        messageContainer.innerHTML += `
        <div style="display: flex; flex-direction: column">
          <div>
            <span class="grey-color">[${currdateFormat}]</span> 
            {{ request.user.first_name }}: <i>${nmd.fields.text}</i> 
          </div>
          <div>
            <i class="material-icons">done</i>
            <i class="material-icons">done</i>
          </div>
        </div>`;
        messageField.value = '';
        document.getElementById('messageDiv').classList.remove('is-dirty');
    } catch (e) {
        console.error('An error occured', e);
    }
  }
</script>

  {% if request.user.is_authenticated %}
  <h1>Chatroom {{ request.user }}</h1>

  <div style="display: flex;  flex-direction: column" id="messageContainer">
    {% for message in messages %}
        <div>
          <span class="grey-color">[{{ message.created_at }}]</span> 
          {{ message.author.first_name }}: <i>{{ message.text }}</i> 
        </div>
        <div>
          <i class="material-icons">done</i>
          <i class="material-icons">done</i>
        </div>
    {% endfor %}
  </div>

  <form onsubmit="sendMessage(); return false;" method="post">
      {% csrf_token %}
      <div id="messageDiv" class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
        <label class="mdl-textfield__label" for="messageField">Message from {{ request.user.first_name }}</label>
        <input class="mdl-textfield__input" type="text" id="messageField" name="textmessage" onkeyup="enableSendBtn()" maxlength="500">
      </div>
      <button id='sendBtn' disabled class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
        Send
      </button>
  </form>

  

  {% else %}
    <h1>Not logged in</h1>
    <p>
      You are currently not logged in. Please log in. <br>
      Please click <a href="/login/">here</a>.

    </p>
  {% endif %}
{% endblock %}